<!--
`launcher-root-partial` - Custom Element (w/ Polymer's TempalteBinding)
with predefined template content, which should be used to include partials.
It's just <template is="imported-template"> wrapped within <juicy-tiles> and layout editor.
Uses juicy-tiles setup given from DB as juicyTilesSetup.

@FIXME (tomalec): Use scoped Partial and layout data once implemented on server-side
-->
<!-- Import dependencies -->
<!-- <link rel="import" href="/sys/polymer/polymer.html"> -->

<!-- <link rel="import" href="/sys/imported-template/imported-template.html"> -->
<link rel="import" href="/sys/juicy-tile-grid/src/juicy-tile-grid.html">
<link rel="import" href="/sys/juicy-tiles-setup-sync/src/juicy-tiles-setup-sync.html">
<!-- <link rel="import" href="/sys/console-log/console-log.html"> -->

<template id="partial-template">
  <template bind>
    <!-- FIXME: one-way binding here is temporary workaround for servers not accepting JSON-Patch (tomalec) -->
    <juicy-tiles-setup-sync 
        name="{{PartialId}}" 
        storedValue="[[juicyTilesSetup]]" 
        apiUrl="/launcher/juicytilessetup"></juicy-tiles-setup-sync>
    <juicy-tile-grid
        name="{{PartialId}}"
        setup="[[ juicyTilesSetup | clonedSetup  ]]"
        defaultTileSetup="{
            'heightAuto': true,
            'width': '100%',
            'heightDynamic': true
        }">
      <aatemplate is="imported-template" content="{{Html}}"></template>
    </juicy-tile-grid>
   <!-- unfortunately [[ obj ]] does not work deep (for nested properties) so we need clonedSetup-->
  </template>
</template>
<link rel="import" href="/sys/polymer/polymer.html">
<script>
  (function (scope) {
    var ImportedTemplatePrototype = Object.create( (HTMLTemplateElement || HTMLElement ).prototype);

    ImportedTemplatePrototype.loadTemplate_ = function() {
      var val = this.getAttribute('content');
      var asIframe = this.getAttribute("iframe") || this.getAttribute("iframe")==="";
      if (val && (val.indexOf('/') === 0 || val.indexOf('./') === 0)) {
        if( asIframe ){
          return this._importIframe(val);
        } else {
          return this._importHTMLImport(val);
        }
      }
      else {
        if( asIframe ){
          return this._importIframe(undefined, encodeURI(val) );
        } else {
          //val is HTML code, insert the partial from the string
          return this._importInline(val);
        }
      }
    };
    /**
     * Import given file, or source as iframe.
     * @public only for debugging.
     * @param  {String} src    file path
     * @param  {String} srcdoc HTML source code
     * @return {imported-template}        self
     */
    ImportedTemplatePrototype._importIframe = function(src, srcdoc){
      this.clear();
      var iframe = this.subTemplate = document.createElement('iframe');
      iframe.src = src;
      srcdoc && (iframe.srcdoc = srcdoc);
      this.parentNode.insertBefore(iframe, this.nextSibling);
      return this;
    };
    /**
     * Import inline html as template
     * @public only for debugging.
     * @param  {String} html html source code
     * @return {imported-template}      self
     */
    ImportedTemplatePrototype._importInline = function(html) {
      if( this.subTemplate ){
        // IDEA: or maybe just this.subTempalte.clear()? - to leave lightDOM template untouched (tomalec)
        this.clear();
      } else {
        this.subTemplate = document.createElement("template");
      }
      this.subTemplate.setAttribute("bind","");
      this.subTemplate.innerHTML = html;
      return this._insertTemplate();
    };
    /**
     * Import partial via HTML Import, and replicate its `<template>`.
     * @IDEA: return promise (if supported) for document load (tomalec)
     * @public only for debugging.
     * @param  {String} href partial URL
     * @return {imported-template}      self
     */
    ImportedTemplatePrototype._importHTMLImport = function(href){
      //href is a URL, load the partial from the HTTP server/cache
      var link = document.createElement('link');
      link.rel = "import";
      link.href = href;
      var xhtml = this;
      link.onload =  function processImportedDocument(){

      // TODO: consider once https://github.com/Polymer/polymer/issues/1127 
      //        and http://crbug.com/389566 will be resolved (tomalec)
      // Polymer.import([href], function processImportedDocument(){
        xhtml.clear();
        // TODO: clear previous template (tomalec)
        // find only root templates
        var templates = this.import.querySelectorAll("head>template,body>template,imported-template-scope>template");
        var template;
        // debugger
        // many teamplates (merged partial), wrap them with one.
        if(templates.length === 1 && templates[0].hasAttribute("processed")) {
          //IDEA (tomalec): consider caching references to templates url->processed instance
          template = templates[0];
        } else if( templates.length >= 1 ){
          // IDEA: create it in main document, attach reference to imported-template instance, and keep imported untouched. (tomalec)
          var template = this.import.createElement("template");
          template.setAttribute("bind","");
          // move entire content to tempalte
          // TODO: check if moving by text is faster, 
          //      as we assume those are templates => document fragments (tomalec)
          for( var nodeNo=0; nodeNo < templates.length; nodeNo++){
            var singleTemplate = templates[nodeNo];
            var hasBind = singleTemplate.hasAttribute("bind");

            if(singleTemplate.parentElement.tagName === "IMPORTED-TEMPLATE-SCOPE"){
              if(hasBind){
                console.warn("Your template ", singleTemplate, " already has `bind` attribute, it will be replaced");
              }
              singleTemplate.setAttribute("bind", singleTemplate.parentElement.getAttribute("scope"));
            } else if ( !hasBind ){
              singleTemplate.setAttribute("bind","");
            }
            template.content.appendChild(singleTemplate);
          }
          template.setAttribute("processed", "");
          this.import.body.appendChild(template);

        } else { //there is no template in the response. 
          // it could be a stack trace, or HTML document with imports, etc. which could be hard to handle
          console.error("DON'T misbehave! At least one <template> tag is expected in content body", this.import.body.innerHTML);
          return;
        }
        // TODO: rewrite binding attributes here (tomalec)
        // var xhtml.subTemplate = document.importNode(template.content, true);
        xhtml.subTemplate = document.importNode(template, true);
        xhtml._insertTemplate();

      };
      // guessed workaround for Polyjuice/Launcher#82, Polymer/polymer#554, http://crbug.com/389566
      setTimeout( function appendAsync(){
          document.head.appendChild(link);
      });
      return this;
    };

    /**
     * Insert template into DOM.
     * @public only for debugging.
     * @param  {String} href partial URL
     * @return {imported-template}      self
     */
    ImportedTemplatePrototype._insertTemplate = function(){
      var that = this;
      var subTemplate = this.subTemplate;
      subTemplate.setAttribute("bind", this.getAttribute("bind") || "");
      
      if(this.hasAttribute("repeat")) {
        subTemplate.setAttribute("repeat", this.getAttribute("repeat") );
      }
      if(this.hasAttribute("if")) {
        subTemplate.setAttribute("if", this.getAttribute("if") );
      }

      if(window.PolymerExpressions) {
        subTemplate.bindingDelegate = new PolymerExpressions(); //use PolymerExpressions if available. This allows <template if="{{val == 1}}">, etc
      }
      // insert after
      this.parentNode.insertBefore(subTemplate, this.nextSibling);
      // attach model once all Polymer Elements are ready
      Polymer.whenReady(function(){
        that.subTemplate.model = that.model;
      });
      return this;
    };

    /**
     * Empty template content.
     * @requires HTMLTemplateElement#clear (https://github.com/Polymer/TemplateBinding/blob/51df59c16e0922dec041cfe604016aac00918d5d/src/TemplateBinding.js#L595)
     * @extends HTMLTemplateElement.prototype.clear
     * @return  see HTMLTemplateElement.prototype.clear
     */
    ImportedTemplatePrototype.clear = function(){
      // return false;
      return this.subTemplate
            && ( !this.subTemplate.clear || this.subTemplate.clear() || true)
            && this.subTemplate.parentNode.removeChild(this.subTemplate);
      // IDEA: clear also content? (tomalec)        
      //      && HTMLTemplateElement.prototype.clear.call(this);
    };

    ImportedTemplatePrototype.createdCallback = function () {

      debugger;
    };
    ImportedTemplatePrototype.isAttached =  false;
    ImportedTemplatePrototype.attachedCallback = function () {
      debugger
      this.isAttached = true;
      this.loadTemplate_();
    };
    ImportedTemplatePrototype.detachedCallback = function(){
      this.isAttached = false;
    };
    ImportedTemplatePrototype.attributeChangedCallback = function(name, oldVal, newVal){
      if(this.isAttached && (name === "content" || name === "iframe")) {
        this.loadTemplate_();
      }
    };

   
  // })(window);

  // (function () {


    var templ = (document._currentScript || document.currentScript).ownerDocument.getElementById("partial-template");

    // var templateAttribute = {
    //   'repeat': true,
    //   'bind': true,
    //   'if': true
    // };
    // function rewriteTempalteAttributes(from, to){      
    //   var attribs = from.attributes;
    //   var count = attribs.length;
    //   while (count-- > 0) {
    //     var attrib = attribs[count];
    //     if (templateAttribute[attrib.name]) {
    //       if (attrib.name !== 'template')
    //         to.setAttribute(attrib.name, attrib.value);
    //       from.removeAttribute(attrib.name);
    //     }
    //   }
    // }

    function inDocumentFragment(element){
      var parent = element.parentNode;
      while( parent && !(parent instanceof DocumentFragment) ){
        parent = parent.parentNode;
      }
      return parent instanceof DocumentFragment;
    }

   var LauncherPartialPrototype = Object.create(ImportedTemplatePrototype);
// b = document.createElement("template","imported-template");
// LauncherPartialPrototype = b.constructor.prototype;
    /**
     * Use predefined template content, rewrite attributes.
     */
    LauncherPartialPrototype.createdCallback = function LPartialCreated(){
    	debugger
      // ugly https://code.google.com/p/chromium/issues/detail?id=430578 workaround
      if( inDocumentFragment( this ) ){
        return ;
      }
      var sroot = this.createShadowRoot();
      sroot.innerHTML = "<style>:host{display:block;}</style><content></content>";

      var clone = document.importNode( templ.content, true);
      var innerTempl = clone.querySelector("template");
      innerTempl.bindingDelegate = new PolymerExpressions();
      innerTempl.bindingDelegate.clonedSetup = {
        toDOM: function (json, letter) {
          // debugger
          if(typeof json == "object"){
            return JSON.parse(JSON.stringify(json));
          } else{
            return json;
          }
        },
        toModel: function (json, letter) {
          // debugger
          if(typeof json == "object"){
            return JSON.parse(JSON.stringify(json));
          } else{
            return json;
          }
        }
      };
      // rewriteTempalteAttributes( this, innerTempl );
      this.innerTempl = innerTempl;
      this.appendChild( clone );
    };
    /**
     * Attach model.
     */
    LauncherPartialPrototype.attachedCallback = function LPartialAttached(){
      var model = this.innerTempl.templateInstance.model;
      // var model = this.templateInstance.model;
      //
      // var model = this.innerTempl.templateInstance ?
      //     this.innerTempl.templateInstance.model :
      //     this.templateInstance.model;

      !model.PartialId && console.warn("PartialId for", this, "is missing");
      
      this.innerTempl.model = model;
    };

    document.registerElement('imported-template', {
      prototype: LauncherPartialPrototype,
      extends: "template"
    });   
  })();
</script>
