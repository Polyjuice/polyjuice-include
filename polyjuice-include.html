<!--
`launcher-root-partial` - Custom Element (w/ Polymer's TempalteBinding)
with predefined template content, which should be used to include partials.
It's just <template is="imported-template"> wrapped within <juicy-tiles> and layout editor.
Uses juicy-tiles setup given from DB as juicyTilesSetup.
version: 0.0.5

@FIXME (tomalec): Use scoped Partial and layout data once implemented on server-side
@FIXME (tomalec): DRY with default polyjuice-include
-->
<!-- Import dependencies -->
<!-- <link rel="import" href="/sys/polymer/polymer.html"> -->

<link rel="import" href="../imported-template/imported-template.html">
<link rel="import" href="../juicy-tile-grid/src/juicy-tile-grid.html">
<link rel="import" href="../juicy-tiles-setup-sync/src/juicy-tiles-setup-sync.html">
<!-- <link rel="import" href="/sys/console-log/console-log.html"> -->

<template id="partial-template">
  <template bind>
    <!-- FIXME: one-way binding here is temporary workaround for servers not accepting JSON-Patch (tomalec) -->
    <juicy-tiles-setup-sync 
        name="{{PartialId}}" 
        storedValue="[[juicyTilesSetup]]" 
        apiUrl="/launcher/juicytilessetup"></juicy-tiles-setup-sync>
    <juicy-tile-grid
        name="{{PartialId}}"
        setup="[[ juicyTilesSetup | clonedSetup  ]]"
        defaultTileSetup="{
            'heightAuto': true,
            'width': '100%',
            'heightDynamic': true
        }"
        refreshonmutation
        refreshonresize>
      <template is="imported-template" content="{{Html}}"></template>
    </juicy-tile-grid>
   <!-- unfortunately [[ obj ]] does not work deep (for nested properties) so we need clonedSetup-->
  </template>
</template>
<script>
  (function () {


    var templ = (document._currentScript || document.currentScript).ownerDocument.getElementById("partial-template");

    function inDocumentFragment(element){
      var parent = element.parentNode;
      while( parent && !(parent instanceof DocumentFragment) ){
        parent = parent.parentNode;
      }
      return parent instanceof DocumentFragment;
    }

    var LauncherPartialPrototype = Object.create(HTMLElement.prototype);

    LauncherPartialPrototype.partial = null;
    LauncherPartialPrototype.isAttached = false;

    /**
     * @see Polyjuice/polyjuice-include - partialAttributeToProperty It's just a copy
     */
    function partialAttributeToProperty(element){
      var attrVal = element.getAttribute("partial");
      // no value, or Polymer binding
      if(!attrVal || attrVal.match(/\{\{.*\}\}|\[\[.*\]\]/)){
        return;
      }
      element.partial = JSON.parse(attrVal);
    }
    /**
     * Use predefined template content, rewrite attributes.
     */
    LauncherPartialPrototype.createdCallback = function LPartialCreated(){
      // ugly https://code.google.com/p/chromium/issues/detail?id=430578 workaround
      if( inDocumentFragment( this ) ){
        return ;
      }
      var partial = undefined;
      var polyjuiceInclude = this;
      // define a setter for partial attribute, 
      // so it could be change by VanillaJs without Polymer Template Binding
      Object.defineProperty(this,"partial",{
        set: function(newValue){
          //d console.log("partial set");
          partial = newValue;
          polyjuiceInclude.partialChanged(partial);
        },
        get: function(){
          return partial;
        }
      });

      var sroot = this.createShadowRoot();
      sroot.innerHTML = "<style>:host{display:block;}</style><content></content>";

      var clone = document.importNode( templ.content, true);
      var innerTempl = clone.querySelector("template");
      innerTempl.bindingDelegate = new PolymerExpressions();
      innerTempl.bindingDelegate.clonedSetup = {
        toDOM: function (json, letter) {
          // debugger
          if(typeof json == "object"){
            return JSON.parse(JSON.stringify(json));
          } else{
            return json;
          }
        },
        toModel: function (json, letter) {
          // debugger
          if(typeof json == "object"){
            return JSON.parse(JSON.stringify(json));
          } else{
            return json;
          }
        }
      };
      // rewriteTempalteAttributes( this, innerTempl );
      this.innerTempl = innerTempl;
      this.appendChild( clone );
    };
    /**
     * Attach model.
     * @see Polyjuice/polyjuice-include#attachedCallback It's just a copy
     */
    LauncherPartialPrototype.attachedCallback = function LPartialAttached(){
      partialAttributeToProperty(this);
      this.isAttached = true;
      //d console.log("polyjuice-partial attached");
      this.partialChanged();
    };
    /**
     * @see Polyjuice/polyjuice-include#detachedCallback It's just a copy
     * @return {[type]} [description]
     */
    LauncherPartialPrototype.detachedCallback = function(){
      this.isAttached = false;
      //d console.log("polyjuice-partial detached");
    };
    /**
     * @see Polyjuice/polyjuice-include#attributeChangedCallback It's just a copy
     */
    LauncherPartialPrototype.attributeChangedCallback = function(name, oldVal, newVal){
      partialAttributeToProperty(this);
      //d console.log("polyjuice-partial attr changed");
    };
    /**
     * Updates inner `imported-template` with partial data given (if applicable)
     * @see Polyjuice/polyjuice-include#partialChanged it's alsmost a copy
     * @param  {Object} newVal new partial value
     */
    LauncherPartialPrototype.partialChanged = function(newVal){
      if(this.partial){
        var html = this.partial.Html;
        !html && console.warn("partial.Html for", this, "is missing.");
        !this.partial.PartialId && console.warn("partial.PartialId for", this, "is missing.");
        if(this.isAttached && html){
          this.innerTempl.model = this.partial;
        }
      }      
    };
    /**
     * Support for Polymers object to attribute binding
     * @see Polyjuice/polyjuice-include#bind It's just a copy
     * @param  {String} name       [description]
     * @param  {Object} observable [description]
     * @param  {Boolean} oneTime   [description]
     * @return {Object}            observer
     */
    LauncherPartialPrototype.bind = function(name, observable, oneTime) {
      if (name === 'partial') {
        // observable callback
        var self = this;
        function updateValue(value) {
          //d console.log(name, "updated");
          self[name] = value;
        }
        // resolve initial value
        var value = observable.open(updateValue);
        updateValue(value);
        // register and return observable
        var observer = {
          close: function() {
            observable.close();
          }
        };
        this[name+"Observer"] = observer;
        return observer;
      }
      else {
         return HTMLElement.prototype.bind.call(
          this, name, observable, oneTime
        );
      }
    };

    document.registerElement('polyjuice-include', {
      prototype: LauncherPartialPrototype
    });   
  })();
</script>
