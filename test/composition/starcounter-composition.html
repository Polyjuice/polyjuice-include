<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script>
        window.JuicyComposition = {shadow: 'v0'};
    </script>
    <script src="../../../webcomponentsjs/webcomponents.js"></script>
    <script src="../../../document-register-element/build/document-register-element.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>
    <script src="../helpers/chainable-methods-for-partial.js"></script>

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../../starcounter-include.html">
</head>

<body>
    <test-fixture id="default-composition">
        <template>
            <starcounter-include partial="{
                &quot;CompositionProvider&quot;: {
                    &quot;PartialId&quot;: &quot;given PartialId&quot;
                },
                &quot;App&quot;: {
                    &quot;Html&quot;: &quot;template_w_starcounter-composition.html&quot;,
                    &quot;doesItWork&quot;: &quot;works!&quot;
                }
            }"></starcounter-include>
        </template>
    </test-fixture>
    <template id="reference-composition">
        <h2>Custom Shadow DOM composition</h2>
		<slot name="my-slot"></slot>
    </template>
    <template id="reference-composition-v1-to-v0">
        <h2>Custom Shadow DOM composition</h2>
		<content name="my-slot" select="[slot='my-slot']"></content>
    </template>


    <script>
    describe('starcounter-include when imports a template that contains <code>template is="starcounter-composition"</code>', function () {
        const useShadowDOMV1 = Boolean(Element.prototype.attachShadow && Node.prototype.getRootNode);
        const REFERENCE_COMPOSITION = useShadowDOMV1 ? '#reference-composition' : '#reference-composition-v1-to-v0'

        var scInclude;
        var partial = {
            "CompositionProvider": {
                "PartialId": "given PartialId"
            },
            "App": {
                "Html": "template_w_starcounter-composition.html",
                "doesItWork": "works!"
            }
        };
        afterEach(function (done) {
            console.warn.restore();
            // give more time to polyfill cleanup
            setTimeout(done);
        });
        beforeEach(function (done) {
            sinon.spy(console, 'warn');
            scInclude = fixture('default-composition');
            // scInclude.partial = JSON.parse(JSON.stringify(partial));
            setTimeout(done, 500);
        });
        it('should use it as its composition', function () {
            expect(scInclude.shadowRoot).to.be.not.null;
            expect(scInclude.shadowRoot.innerHTML.trim()).to.be
                .equal(document.querySelector(REFERENCE_COMPOSITION).innerHTML.trim());
        });
        it('should call console warn with new name', function () {
            expect(console.warn).to.be.called;
            expect(console.warn.args[0][0]).to.contain('declarative-shadow-dom');
        });
        describe('after partial property is replaced with the partial that also does contain default composition', function () {
            beforeEach(function (done) {
                scInclude.partial = JSON.parse(JSON.stringify(partial));
                setTimeout(done, 500);
            });
            it('should use it as its composition', function () {
                expect(scInclude.shadowRoot).to.be.not.null;
                expect(scInclude.shadowRoot.innerHTML.trim()).to.be
                    .equal(document.querySelector(REFERENCE_COMPOSITION).innerHTML.trim());
            });
        });

    });
    </script>

</body>

</html>
