<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script>
        window.JuicyComposition = {shadow: 'v0'};
    </script>
    <script src="../../../webcomponentsjs/webcomponents.js"></script>
    <script src="../../../document-register-element/build/document-register-element.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>
    <script src="../helpers/chainable-methods-for-partial.js"></script>

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../../starcounter-include.html">
</head>

<body>
    <test-fixture id="default-composition">
        <template>
            <starcounter-include partial="{
                &quot;CompositionProvider&quot;: {
                    &quot;PartialId&quot;: &quot;given PartialId&quot;
                },
                &quot;App&quot;: {
                    &quot;Html&quot;: &quot;template_w_declarative-shadow-dom.html&quot;,
                    &quot;doesItWork&quot;: &quot;works!&quot;
                }
            }"></starcounter-include>
        </template>
    </test-fixture>
    <template id="reference-composition">
        <h2>Custom Shadow DOM composition</h2>
        <slot name="my-slot"></slot>
    </template>
    <template id="reference-alternative-composition">
        <h2>Custom Shadow DOM alternative composition</h2>
        <slot name="my-slot"></slot>
    </template>
    <template id="reference-composition-v1-to-v0">
        <h2>Custom Shadow DOM composition</h2>
        <content name="my-slot" select="[slot='my-slot']"></content>
    </template>
    <template id="reference-alternative-composition-v1-to-v0">
        <h2>Custom Shadow DOM alternative composition</h2>
        <content name="my-slot" select="[slot='my-slot']"></content>
    </template>


    <script>
    describe('starcounter-include when imports a template that contains <code>template is="declarative-shadow-dom"</code>', function () {
        const useShadowDOMV1 = Boolean(Element.prototype.attachShadow && Node.prototype.getRootNode);
        const REFERENCE_COMPOSITION = useShadowDOMV1 ? '#reference-composition' : '#reference-composition-v1-to-v0'
        const REFERENCE_ALTERNATIVE_COMPOSITION = useShadowDOMV1 ? '#reference-alternative-composition' : '#reference-alternative-composition-v1-to-v0'

        var scInclude;
        var alternativePartial = {
            "CompositionProvider": {
                "PartialId": "given PartialId"
            },
            "App": {
                "Html": "template_w_declarative-shadow-dom-alternative.html",
                "doesItWork": "works!"
            }
        };
        afterEach(function (done) {
            // give more time to polyfill cleanup
            setTimeout(done);
        });
        beforeEach(function (done) {
            scInclude = fixture('default-composition');
            // scInclude.partial = JSON.parse(JSON.stringify(partial));
            setTimeout(done, 500);
        });
        it('should use it as its composition', function () {
            expect(scInclude.shadowRoot).to.be.not.null;
            expect(scInclude.shadowRoot.innerHTML.trim()).to.be
                .equal(document.querySelector(REFERENCE_COMPOSITION).innerHTML.trim());
        });
        describe('after partial property is replaced with the partial that also does contain default composition', function () {
            beforeEach(function (done) {
                scInclude.partial = JSON.parse(JSON.stringify(alternativePartial));
                setTimeout(done, 500);
            });
            it('should use it as its composition', function () {
                expect(scInclude.shadowRoot).to.be.not.null;
                expect(scInclude.shadowRoot.innerHTML.trim()).to.be
                    .equal(document.querySelector(REFERENCE_ALTERNATIVE_COMPOSITION).innerHTML.trim());
            });
        });
        describe('after composition is changed from default to explicit', function () {
            var explicitComposition = "explicit composition";
            beforeEach(function () {
                scInclude._compositionChanged(explicitComposition);
            });
            it('should render the explicit composition', function () {
                expect(scInclude.shadowRoot.innerHTML.trim()).to.be.equal(explicitComposition);
            });
            it('should return to default after resetting', function () {
                scInclude._compositionChanged(""); //this is how starcounter-layout-html-editor resets
                expect(scInclude.shadowRoot.innerHTML.trim()).to.be
                    .equal(document.querySelector(REFERENCE_COMPOSITION).innerHTML.trim());
            });
        });
        describe('after partial property is replaced with itself', function () {
            it('should keep using the existing composition', function (done) { //otherwise ViewKeeper (aka workspaces) do not keep state in Firefox and Edge
                var old  = scInclude.shadowRoot.querySelector("h2");
                scInclude.partial = scInclude.partial;
                setTimeout(function() {
                    expect(old).to.be.not.null;
                    expect(old).to.be.equal(scInclude.shadowRoot.querySelector("h2"));
                    done();
                }, 500);
            });
        });

    });
    </script>

</body>

</html>
