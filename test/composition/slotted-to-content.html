<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

	<script src="../../../webcomponentsjs/webcomponents.js"></script>
	<script src="../../../web-component-tester/browser.js"></script>
	<script src="../helpers/chainable-methods-for-partial.js"></script>

	<!-- Step 1: import the element to test -->
	<link rel="import" href="../../starcounter-include.html">
</head>

<body>
	<test-fixture id="default-composition">
		<template>
			<starcounter-include partial="{
				&quot;LauncherLayoutInfo&quot;: {
					&quot;PartialId&quot;: &quot;given PartialId&quot;
				},
				&quot;Html&quot;: &quot;../template_w_declarative-shadow-dom_and_slotted.html&quot;,
				&quot;doesItWork&quot;: &quot;works!&quot;
			}"></starcounter-include>
		</template>
	</test-fixture>
	<template id="reference-composition">
		<style>
			.foo,
			::content p,
			.bar{
				color: green;
			}
		</style>
		<h2>Shadow DOM prepared for V1</h2>
		<content name="my-slot" select="[slot='my-slot']"></content>
	</template>

	<script id="toBeLoadedAsString" type="text/html">
		<style>
			.foo,
			::slotted(p),
			.bar{
				color: green;
			}
		</style>
		<h2>Shadow DOM prepared for V1</h2>
		<slot name="my-slot"></slot>
	</script>


	<script>
	describe('starcounter-include when imports a template that contains <code>template is="declarative-shadow-dom"</code> which contains <code>slot</code>s', function () {

		var scInclude;
		var partial = {
			"LauncherLayoutInfo": {
				"PartialId": "given PartialId"
			},
			"Html": "../template_w_declarative-shadow-dom_and_slotted.html",
			"doesItWork": "works!"
		};
		afterEach(function (done) {
			// give more time to polyfill cleanup
			setTimeout(done);
		});
		beforeEach(function (done) {
			scInclude = fixture('default-composition');
			// scInclude.partial = JSON.parse(JSON.stringify(partial));
			setTimeout(done, 500);
		});
		it('should replace them with applicable slots', function () {
			expect(document.querySelector('juicy-composition')).to.be.not.null;
			expect(document.querySelector('juicy-composition').composition).to.be.not.null;
			expect(document.querySelector('juicy-composition').composition.innerHTML.trim()).to.be
				.equal(document.querySelector('#reference-composition').innerHTML.trim());
		});
		describe('after partial property is replaced with the partial that also does contain default composition and slots', function () {
			beforeEach(function (done) {
				scInclude.partial = JSON.parse(JSON.stringify(partial));
				setTimeout(done, 500);
			});
			it('should replace them with applicable slots', function () {
				expect(document.querySelector('juicy-composition')).to.be.not.null;
				expect(document.querySelector('juicy-composition').composition).to.be.not.null;
				expect(document.querySelector('juicy-composition').composition.innerHTML.trim()).to.be
					.equal(document.querySelector('#reference-composition').innerHTML.trim());
			});
		});
		describe('after composition property is replaced with the stringified one that also does contain slots', function () {
			var compositionString = document.getElementById('toBeLoadedAsString').textContent;
			beforeEach(function (done) {
				var newPartial = JSON.parse(JSON.stringify(partial));
				// newPartial.Html = '../templateToInclude.html';
				newPartial.LauncherLayoutInfo.Composition$ = compositionString;
				scInclude.partial = newPartial;
				setTimeout(done, 500);
			});
			it('should replace them with applicable slots', function () {
				expect(document.querySelector('juicy-composition')).to.be.not.null;
				expect(document.querySelector('juicy-composition').composition).to.be.not.null;
				expect(document.querySelector('juicy-composition').composition.innerHTML.trim()).to.be
					.equal(document.querySelector('#reference-composition').innerHTML.trim());
			});
		});

	});
	</script>

</body>

</html>
