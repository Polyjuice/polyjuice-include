<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../webcomponentsjs/webcomponents.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>
    <script src="../helpers/chainable-methods-for-partial.js"></script>

    <link rel="import" href="../../starcounter-include.html">
    <script src="../helpers/WCT-Polyfill_bugs_workaround.js"></script>
</head>

<body>

    <test-fixture id="full">
        <template>
            <starcounter-include partial="{&quot;Html&quot;: &quot;../templateToInclude.html&quot;, &quot;doesItWork&quot;: &quot;works!&quot;}"></starcounter-include>
        </template>
    </test-fixture>

    <test-fixture id="htmlnull">
        <template>
            <starcounter-include partial="{&quot;Html&quot;: null, &quot;doesItWork&quot;: &quot;works!&quot;}"></starcounter-include>
        </template>
    </test-fixture>

    <!-- References: -->
    <test-fixture id="nothing">
        <template>
            <starcounter-include></starcounter-include>
        </template>
    </test-fixture>
    <test-fixture id="old">
        <template>
            <starcounter-include partial="{&quot;Html&quot;: &quot;../old_templateToInclude.html&quot;, &quot;doesItWork&quot;: &quot;worked!&quot;}"></starcounter-include>
        </template>
    </test-fixture>

    <script>
        var scInclude, importedTemplate, previousModel;
        describe('with `Html` property', function(){
            afterEach(function(){
                if(scInclude.parentElement){
                    scInclude.parentElement.removeChild(scInclude);
                }
            });
            var fixtureId = 'full',
                model = {
                    "Html": "../templateToInclude.html",
                    "doesItWork": "works!"
                };

            function testAllAttributes(){
                beforeEach(function(){
                     importedTemplate = scInclude.querySelector_template_for_buggy_polyfill();
                });
                it('should attach `.Html` property as content attribute for `imported-template`', function () {
                    expect(importedTemplate.getAttribute("content")).to.equal(scInclude.partial.Html);
                });
                it('should NOT attach partial model to `imported-template` immediately', function () {
                    expect((importedTemplate.model)).to.equal(previousModel || null);
                });
                it('should attach same partial model to `imported-template` on `stamping` (after connected to DOM)', function (done) {
                    // attach element if not attached yet.
                    if(!document.contains(scInclude)){
                        console.info('attaching');
                        document.body.appendChild(scInclude);
                    }
                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        expect(importedTemplate.model).to.equal(scInclude.partial);
                        done();
                    });
                });
            }
            describe('set once element is created programatically', function(){
                beforeEach(function(){
                     scInclude = document.createElement('starcounter-include');
                     previousModel = null;
                     scInclude.partial = clone(model);
                });
                testAllAttributes();
            });

            describe('set after element was attached', function(){
                beforeEach(function(){
                     scInclude = fixture('nothing');
                     previousModel = null;
                     scInclude.partial = clone(model);
                });
                testAllAttributes();
            });
            describe('changed after element was attached', function(){
                beforeEach(function(done){
                     scInclude = fixture('old');
                     previousModel = scInclude.partial;
                     scInclude.querySelector_template_for_buggy_polyfill().addEventListener('stamping', function afterStamped(){
                         scInclude.querySelector_template_for_buggy_polyfill().removeEventListener('stamping', afterStamped);
                         scInclude.partial = clone(model);
                         done();
                     });

                });
                testAllAttributes();
            });

            describe('changed after element was attached and stamped to the new object, with the same Html, model should be attached immediately', function (done) {
                beforeEach(function(done){
                    scInclude = fixture('full');
                    importedTemplate = scInclude.querySelector_template_for_buggy_polyfill();

                    importedTemplate.addEventListener('stamping', function afterAttached(){
                        importedTemplate.removeEventListener('stamping', afterAttached);
                        setTimeout(function(){
                            let oldModel = scInclude.partial;
                            let newModel = clone(oldModel);
                            newModel.doesItWork = 'still works!';
                            scInclude.partial = newModel;
                            done();
                        });
                    });
                });
                it('should attach `.Html` property as content attribute for `imported-template`', function () {
                    expect(importedTemplate.getAttribute("content")).to.equal(scInclude.partial.Html);
                });
                it('should attach partial model to `imported-template` immediately', function () {
                    expect(importedTemplate.model).to.equal(scInclude.partial);
                });
            });

            describe('set after element was detached', function(){
                beforeEach(function(){
                     scInclude = fixture('nothing');
                     previousModel = null;
                     scInclude.parentElement.removeChild(scInclude);
                     scInclude.partial = clone(model);
                });
                testAllAttributes();
            });
            describe('changed after element was detached', function(){
                beforeEach(function(done){
                     scInclude = fixture('old');
                     previousModel = scInclude.partial;
                     scInclude.querySelector_template_for_buggy_polyfill().addEventListener('stamping', function afterStamped(){
                         scInclude.querySelector_template_for_buggy_polyfill().removeEventListener('stamping', afterStamped);
                         scInclude.parentElement.removeChild(scInclude);
                         scInclude.partial = clone(model);
                         done();
                     });
                });
                testAllAttributes();
            });
        });
        describe('with `Html` set to null', function(){
            afterEach(function(){
                if(scInclude.parentElement){
                    scInclude.parentElement.removeChild(scInclude);
                }
            });
            var fixtureId = 'htmlnull',
                model = {
                    "Html": null,
                    "doesItWork": "works!"
                };

            function testAllAttributes(){
                beforeEach(function(){
                     importedTemplate = scInclude.querySelector_template_for_buggy_polyfill();
                });
                it('should attach `.Html` property as content attribute for `imported-template`', function () {
                    expect(importedTemplate.getAttribute("content")).to.equal(scInclude.partial.Html);
                });
                it('should attach partial model to `imported-template` immediately', function () {
                    expect((importedTemplate.model)).to.equal(scInclude.partial);
                });
            }
            describe('set once element is created programatically', function(){
                beforeEach(function(){
                     scInclude = document.createElement('starcounter-include');
                     previousModel = null;
                     scInclude.partial = clone(model);
                });
                testAllAttributes();
            });

            describe('set after element was attached', function(){
                beforeEach(function(){
                     scInclude = fixture('nothing');
                     previousModel = null;
                     scInclude.partial = clone(model);
                });
                testAllAttributes();
            });
            describe('changed after element was attached', function(){
                beforeEach(function(done){
                     scInclude = fixture('old');
                     previousModel = scInclude.partial;
                     scInclude.querySelector_template_for_buggy_polyfill().addEventListener('stamping', function afterStamped(){
                         scInclude.querySelector_template_for_buggy_polyfill().removeEventListener('stamping', afterStamped);
                         scInclude.partial = clone(model);
                         done();
                     });

                });
                testAllAttributes();
            });

            describe('set after element was detached', function(){
                beforeEach(function(){
                     scInclude = fixture('nothing');
                     previousModel = null;
                     scInclude.parentElement.removeChild(scInclude);
                     scInclude.partial = clone(model);
                });
                testAllAttributes();
            });
            describe('chnaged after element was detached', function(){
                beforeEach(function(done){
                     scInclude = fixture('old');
                     previousModel = scInclude.partial;
                     scInclude.querySelector_template_for_buggy_polyfill().addEventListener('stamping', function afterStamped(){
                         scInclude.querySelector_template_for_buggy_polyfill().removeEventListener('stamping', afterStamped);
                         scInclude.parentElement.removeChild(scInclude);
                         scInclude.partial = clone(model);
                         done();
                     });
                });
                testAllAttributes();
            });
        });

        describe('when `partial` property is set to', function () {
            [null, undefined].forEach(function (value) {
                describe('`'+ value +'`', function () {
                    describe('should remove content and model attribute and model property from `<imported-template>`', function () {
                        afterEach(function (done) {
                            // give more time to polyfill cleanup
                            setTimeout(done);
                        });
                        it('for element created programatically', function () {
                            scInclude = document.createElement('starcounter-include');
                            scInclude.partial = clone({
                                "Html": "../templateToInclude.html",
                                "doesItWork": "works!"
                            });
                            scInclude.partial = value;

                            expect(scInclude).to.have.descendant('[is="imported-template"]').that.is.a.clearImportedTemplate;
                        });

                        it('after element was attached', function () {
                            scInclude = fixture('old');
                            scInclude.partial = value;

                            expect(scInclude).to.have.descendant('[is="imported-template"]').that.is.a.clearImportedTemplate;
                        });

                        it('after element was detached', function () {
                            scInclude = fixture('old');
                            scInclude.parentElement.removeChild(scInclude);
                            scInclude.partial = value;

                            expect(scInclude).to.have.descendant('[is="imported-template"]').that.is.a.clearImportedTemplate;
                        });

                    });
                });
            });
        });
        function clone (obj) {
            return JSON.parse(JSON.stringify(obj));
        }
    </script>

</body>

</html>
