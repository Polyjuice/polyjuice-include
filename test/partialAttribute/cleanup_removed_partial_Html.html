<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../webcomponentsjs/webcomponents.js"></script>

    <script src="../../../web-component-tester/browser.js"></script>

    <link rel="import" href="../../starcounter-include.html">

    <script src="../helpers/disable-safari-CE.js"></script>
</head>

<body>

    <test-fixture id="nothing">
        <template>
            <starcounter-include></starcounter-include>
        </template>
    </test-fixture>

    <script>
        describe('cleanup after removed partial', function() {
            afterEach(function (done) {
                // give more time to polyfill cleanup
                setTimeout(done);
            });
            var instance;
            var model = {
                "AppA": {
                    "Html": "templateToInclude.html",
                    "doesItWork": "works!"
                }
            };

            beforeEach(function() {
                instance = fixture('nothing');
                instance.partial = clone(model);
            });

            it('when the `partial` attribute is changed to an empty string', function(done) {
                expectPartialToBeAttached();
                instance.setAttribute("partial", "");
                expectPartialToBeCleanedUp();
                done();
            });

            it('when the `partial` property is changed to an empty string', function(done) {
                expectPartialToBeAttached();
                instance.partial = "";
                expectPartialToBeCleanedUp();
                done();
            });

            it('when the `partial` property is changed to null', function(done) {
                expectPartialToBeAttached();
                instance.partial = null;
                expectPartialToBeCleanedUp();
                done();
            });

            it('when the `partial` property is changed to undefined', function(done) {
                expectPartialToBeAttached();
                instance.partial = undefined;
                expectPartialToBeCleanedUp();
                done();
            });

            // --
            // This functionality is being discussed at
            // https://github.com/Starcounter/starcounter-include/issues/12
            it('when the `partial` property is changed to empty object', function(done) {
                expectPartialToBeAttached();
                instance.partial = {};
                expectPartialToBeCleanedUp();
                done();
            });

            xit('when the `partial` property is changed to an object without Html', function(done) {
                expectPartialToBeAttached();
                instance.partial = {
                    "doesItWork": "works!"
                };
                expectPartialToBeCleanedUp();
                done();
            });
            // --

            it('when the `partial` property is changed to an object with empty Html sub-property, should request new HTML from just `/sc/htmlmerger?AppA=` - for example to get default declarative Shadow DOM composition', function(done) {
                expectPartialToBeAttached();
                instance.partial = {
                    "AppA":{
                        "Html": "",
                        "doesItWork": "works!"
                    }
                };
                expect(instance.template.getAttribute("href")).to.equal('/sc/htmlmerger?AppA=');
                expect(instance.template.href).to.equal('/sc/htmlmerger?AppA=');
                done();
            });

            function expectPartialToBeAttached() {
                expect(instance.template.getAttribute("href")).to.equal('/sc/htmlmerger?AppA=templateToInclude.html');
                expect(instance.template.href).to.equal('/sc/htmlmerger?AppA=templateToInclude.html');
            }

            function expectPartialToBeCleanedUp() {
                expect(instance.template.getAttribute("href")).to.equal(null);
                expect(instance.template.href).to.equal(null);
            }

            function clone(obj) {
                return JSON.parse(JSON.stringify(obj));
            }
        });
    </script>

</body>

</html>
