<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../../web-component-tester/browser.js"></script>
    <script src="../../../../webcomponentsjs/webcomponents.js"></script>

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../../../starcounter-include.html">
    <script src="../../helpers/WCT-Polyfill_bugs_workaround.js"></script>
</head>

<body>
    <test-fixture id="nested-html">
        <template>
            <starcounter-include partial="{
                &quot;scope1&quot;: {
                    &quot;Html&quot;: &quot;scope1Html&quot;,
                    &quot;doesItWork&quot;: &quot;works!&quot;
                },
                &quot;scope2&quot;: {
                    &quot;Html&quot;: &quot;scope2Html&quot;,
                    &quot;doesItWork&quot;: &quot;works!&quot;
                },
                &quot;scope3&quot;: {
                    &quot;doesItWork&quot;: &quot;works!&quot;
                }
            }"></starcounter-include>
        </template>
    </test-fixture>

    <!-- References: -->
    <test-fixture id="nothing">
        <template>
            <starcounter-include></starcounter-include>
        </template>
    </test-fixture>
    <test-fixture id="old">
        <template>
            <starcounter-include partial="{&quot;Html&quot;: &quot;../../old_templateToInclude.html&quot;, &quot;doesItWork&quot;: &quot;worked!&quot;}"></starcounter-include>
        </template>
    </test-fixture>

    <script>
    describe('starcounter-include with `partial` property without `Html` on root level, but with some namespaces', function () {
        afterEach(function (done) {
            // give more time to polyfill cleanup
            setTimeout(done);
        });
        var scInclude;
        var model = {
            'scope1': {
                'Html': 'scope1Html',
                'doesItWork': 'works!'
            },
            'scope2': {
                'Html': 'scope2Html;,/?:@&=+$',
                'doesItWork': 'works!'
            },
            'scope3': {
                'doesItWork': 'works!'
            }
        };
        var oldModel = {
            "Html": "../../old_templateToInclude.html",
            "doesItWork": "worked!"
        };
        describe('set', function () {


            describe('should attach to `<imported-template>` concatenated `Html`s as content attribute (`/sc/htmlmerger?`+`scope=scope.HTML` for each scope that contains it) and attach partial\'s model only once content is stamped', function () {


                it('for element created programmatically', function (done) {
                    scInclude = document.createElement('starcounter-include');
                    scInclude.partial = clone(model);
                    let importedTemplate = scInclude.querySelector_template_for_buggy_polyfill();

                    expect(importedTemplate.getAttribute("content")).to.equal('/sc/htmlmerger?scope1=scope1Html&scope2=scope2Html%3B%2C%2F%3F%3A%40%26%3D%2B%24&scope3=');
                    expect(importedTemplate.model).to.equal(null);

                    document.body.appendChild(scInclude);

                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        expect(importedTemplate.model).to.equal(scInclude.partial);
                        done();
                    });
                });

                it('if value was set after element was attached', function (done) {
                    scInclude = fixture('nothing');
                    scInclude.partial = clone(model);
                    let importedTemplate = scInclude.querySelector_template_for_buggy_polyfill();

                    expect(importedTemplate.getAttribute("content")).to.equal('/sc/htmlmerger?scope1=scope1Html&scope2=scope2Html%3B%2C%2F%3F%3A%40%26%3D%2B%24&scope3=');
                    expect(importedTemplate.model).to.equal(null);

                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        expect(importedTemplate.model).to.equal(scInclude.partial);
                        done();
                    });
                });

                it('if value was changed after element was attached', function (done) {
                    scInclude = fixture('old');
                    let importedTemplate = scInclude.querySelector_template_for_buggy_polyfill();
                    scInclude.partial = clone(model);

                    expect(importedTemplate.getAttribute("content")).to.equal('/sc/htmlmerger?scope1=scope1Html&scope2=scope2Html%3B%2C%2F%3F%3A%40%26%3D%2B%24&scope3=');
                    expect(importedTemplate.model).to.equal(null);

                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        expect(importedTemplate.model).to.equal(scInclude.partial);
                        // expect it/done to be called only once
                        done();
                    });
                });

                it('if value was changed after element was attached and stamped', function (done) {
                    scInclude = fixture('old');
                    let importedTemplate = scInclude.querySelector_template_for_buggy_polyfill();

                    importedTemplate.addEventListener('stamping', function afterAttached(){
                        let oldModel = scInclude.partial;
                        scInclude.partial = clone(model);

                        expect(importedTemplate.getAttribute("content")).to.equal('/sc/htmlmerger?scope1=scope1Html&scope2=scope2Html%3B%2C%2F%3F%3A%40%26%3D%2B%24&scope3=');

                        expect(importedTemplate.model).to.equal(oldModel);
                        importedTemplate.removeEventListener('stamping', afterAttached);

                        importedTemplate.addEventListener('stamping', function onceStamped(){
                            expect(importedTemplate.model).to.equal(scInclude.partial);
                            done();
                        });
                    });
                });

                it('if value was set after element was detached (model not yet attached)', function () {
                    scInclude = fixture('nothing');
                    scInclude.parentElement.removeChild(scInclude);
                    scInclude.partial = clone(model);

                    let importedTemplate = scInclude.querySelector_template_for_buggy_polyfill();

                    expect(importedTemplate.getAttribute("content")).to.equal('/sc/htmlmerger?scope1=scope1Html&scope2=scope2Html%3B%2C%2F%3F%3A%40%26%3D%2B%24&scope3=');
                    expect(importedTemplate.model).to.equal(null);
                });

                it('if value was set after element was detached, then element is re-attached', function (done) {
                    scInclude = fixture('nothing');
                    let parent = scInclude.parentElement;
                    scInclude.parentElement.removeChild(scInclude);
                    scInclude.partial = clone(model);
                    // re-attach element
                    parent.appendChild(scInclude);

                    let importedTemplate = scInclude.querySelector_template_for_buggy_polyfill();

                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        expect(importedTemplate.getAttribute("content")).to.equal('/sc/htmlmerger?scope1=scope1Html&scope2=scope2Html%3B%2C%2F%3F%3A%40%26%3D%2B%24&scope3=');
                        expect(importedTemplate.model).to.equal(scInclude.partial);
                        done();
                    });

                });

                it('if value was changed after element was detached (model not yet attached)', function (done) {
                    scInclude = fixture('old');
                    scInclude.parentElement.removeChild(scInclude);
                    scInclude.partial = clone(model);
                    let importedTemplate = scInclude.querySelector_template_for_buggy_polyfill();

                    expect(importedTemplate.getAttribute("content")).to.equal('/sc/htmlmerger?scope1=scope1Html&scope2=scope2Html%3B%2C%2F%3F%3A%40%26%3D%2B%24&scope3=');
                    expect(importedTemplate.model).to.equal(null);

                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        expect(importedTemplate.model).to.equal(scInclude.partial);
                        done();
                    });
                });

                it('if value was changed after element was detached, then element is re-attached', function (done) {
                    scInclude = fixture('old');
                    let parent = scInclude.parentElement;
                    scInclude.parentElement.removeChild(scInclude);
                    scInclude.partial = clone(model);
                    // re-attach element
                    parent.appendChild(scInclude);

                    let importedTemplate = scInclude.querySelector_template_for_buggy_polyfill();

                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        expect(importedTemplate.getAttribute("content")).to.equal('/sc/htmlmerger?scope1=scope1Html&scope2=scope2Html%3B%2C%2F%3F%3A%40%26%3D%2B%24&scope3=');
                        expect(importedTemplate.model).to.equal(scInclude.partial);
                        done();
                    });
                });

            });

        });

    });
    function clone(obj) {
        return JSON.parse(JSON.stringify(obj));
    }
    </script>

</body>

</html>
