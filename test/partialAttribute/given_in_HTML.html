<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../webcomponentsjs/webcomponents.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../../starcounter-include.html">
</head>

<body>

    <test-fixture id="full">
        <template>
            <!-- nest to workaround test-fixture bug -->
            <div>
                <starcounter-include partial="{&quot;Html&quot;: &quot;../templateToInclude.html&quot;, &quot;doesItWork&quot;: &quot;works!&quot;}"></starcounter-include>
            </div>
        </template>
    </test-fixture>

    <test-fixture id="htmlnull">
        <template>
            <!-- nest to workaround test-fixture bug -->
            <div>
                <starcounter-include partial="{&quot;Html&quot;: null, &quot;doesItWork&quot;: &quot;works!&quot;}"></starcounter-include>
            </div>
        </template>
    </test-fixture>

    <!-- References: -->
    <test-fixture id="nothing">
        <template>
            <!-- nest to workaround test-fixture bug -->
            <div>
                <starcounter-include></starcounter-include>
            </div>
        </template>
    </test-fixture>
    <test-fixture id="old">
        <template>
            <!-- nest to workaround test-fixture bug -->
            <div>
                <starcounter-include partial="{&quot;Html&quot;: &quot;../old_templateToInclude.html&quot;, &quot;doesItWork&quot;: &quot;worked!&quot;}"></starcounter-include>
            </div>
        </template>
    </test-fixture>

    <script>
        // describe('`partial` attribute is set/updated using HTML methods')
        var scInclude;
        describe('with `Html` property', testSettingPartialAttribute('full', {
            "Html": "../templateToInclude.html",
            "doesItWork": "works!"
        }));
        describe('with `Html` set to null', testSettingPartialAttribute('htmlnull', {
            "Html": null,
            "doesItWork": "works!"
        }));

        function testSettingPartialAttribute(fixtureId, model, referenceHtml) {
            referenceHtml = arguments.length >= 3 ? referenceHtml : model.Html;
            return function() {
                var oldModel = {
                    "Html": "../old_templateToInclude.html",
                    "doesItWork": "worked!"
                };
                describe('once element is created programatically', testAllAttributes(function() {
                    var scInclude = {};
                    scInclude.add = document.createElement('starcounter-include');
                    scInclude.add.setAttribute('partial', JSON.stringify(model));
                    scInclude.update = document.createElement('starcounter-include');
                    scInclude.update.setAttribute('partial', JSON.stringify(oldModel));
                    scInclude.update.setAttribute('partial', JSON.stringify(model));
                    return scInclude;
                }));
                describe('before element was upgraded (directly into HTML markup)', testAllAttributes(function() {
                    var scInclude = {};
                    scInclude.add = scInclude.update = fixture(fixtureId).querySelector('starcounter-include');
                    return scInclude;
                }));
                describe('after element was attached', testAllAttributes(function() {
                    var scInclude = {};
                    scInclude.add = fixture('nothing').querySelector('starcounter-include');
                    scInclude.update = fixture('old').querySelector('starcounter-include');
                    scInclude.add.setAttribute('partial', JSON.stringify(model));
                    scInclude.update.setAttribute('partial', JSON.stringify(model));
                    return scInclude;
                }));
                describe('after element was detached', testAllAttributes(function() {
                    var scInclude = {};
                    scInclude.add = fixture('nothing').querySelector('starcounter-include');
                    scInclude.update = fixture('old').querySelector('starcounter-include');
                    scInclude.add.parentElement.removeChild(scInclude.add);
                    scInclude.update.parentElement.removeChild(scInclude.update);
                    scInclude.add.setAttribute('partial', JSON.stringify(model));
                    scInclude.update.setAttribute('partial', JSON.stringify(model));
                    return scInclude;
                }));

                function testAllAttributes(createInstances) {
                    return function() {
                        var scInclude;
                        beforeEach(function() {
                            scInclude = createInstances();
                        });

                        it('should attach `.Html` property as content attribute for `<imported-template>`', function() {
                            expect(scInclude.add.querySelector("template").getAttribute("content")).to.equal(referenceHtml);
                            expect(scInclude.update.querySelector("template").getAttribute("content")).to.equal(referenceHtml);
                        });
                        it('should attach partial model to `imported-template`', function() {
                            expect(JSON.stringify(scInclude.add.querySelector("template").model)).to.equal(JSON.stringify(model));
                            expect(JSON.stringify(scInclude.update.querySelector("template").model)).to.equal(JSON.stringify(model));
                        });

                    };
                }
            }
        };

        describe('when attribute is removed, should remove content and model attribute and model property from `<imported-template>`', function () {

            it('from element created programatically', function () {
                scInclude = document.createElement('starcounter-include');
                scInclude.setAttribute('partial', JSON.stringify({
                    "Html": "../templateToInclude.html",
                    "doesItWork": "works!"
                }));
                scInclude.removeAttribute('partial');

                expect(scInclude.querySelector("template").hasAttribute("content")).to.be.false;
                expect(scInclude.querySelector("template").hasAttribute('model')).to.be.false;
                expect(scInclude.querySelector("template").model).to.be.falsy;
            });

            it('from attached element', function () {
                scInclude = fixture('old').querySelector('starcounter-include');
                scInclude.removeAttribute('partial');

                expect(scInclude.querySelector("template").hasAttribute("content")).to.be.false;
                expect(scInclude.querySelector("template").hasAttribute('model')).to.be.false;
                expect(scInclude.querySelector("template").model).to.be.falsy;
            });

            it('from detached element', function () {
                scInclude = fixture('old').querySelector('starcounter-include');
                scInclude.parentElement.removeChild(scInclude);
                scInclude.removeAttribute('partial');

                expect(scInclude.querySelector("template").hasAttribute("content")).to.be.false;
                expect(scInclude.querySelector("template").hasAttribute('model')).to.be.false;
                expect(scInclude.querySelector("template").model).to.be.falsy;
            });
        });
    </script>

</body>

</html>
