
<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../webcomponentsjs/webcomponents.js"></script>
    <script src="../../../document-register-element/build/document-register-element.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>

    <link rel="import" href="../../../polymer/polymer.html">
    <!-- Step 1: import the element to test -->
    <link rel="import" href="../../starcounter-include.html">
    <script src="../helpers/WCT-Polyfill_bugs_workaround.js"></script>
</head>

<body>
    <template id="fixture">
        <template is="dom-bind">
            <starcounter-include partial="{{model.Page}}"></starcounter-include>
        </template>
    </template>
    <better-test-fixture id="container"></better-test-fixture>
    <script>
        function createPartial() {
            return {
                Html: "../old_templateToInclude.html",
                doesItWork: "worked!"
            };
        };
        var changedModel = {
            Html: "../templateToInclude.html",
            doesItWork: "works!"
        };

        describe('after `dom-bind`` was attached to DOM', function() {
            var container = document.querySelector('#container'),
                domBind, include, partial, importedTemplate;
            afterEach(function (done) {
                container.innerHTML = '';
                // give more time to polyfill cleanup
                setTimeout(done);
            });
            beforeEach(function(done) {
                var fixture = document.querySelector('#fixture');
                var clone = document.importNode(fixture.content, true);
                domBind = clone.querySelector('template[is=dom-bind]');
                partial = createPartial();
                domBind.model = {
                    Page: partial
                };
                domBind.addEventListener('dom-change', function(){
                    include = container.querySelector('starcounter-include');
                    importedTemplate = include.querySelector_template_for_buggy_polyfill();
                    done();
                })

                container.appendChild(clone);

            });

            it('should attach `.Html` property as content attribute for `<imported-template>`', function() {
                expect(importedTemplate.getAttribute("content")).to.equal(partial.Html);
            });
            it('should NOT attach partial model to `imported-template` immediately', function () {
                expect(importedTemplate.model).to.equal(null);
            });
            it('should attach partial model to `imported-template` on `stamping`', function (done) {
                importedTemplate.addEventListener('stamping', function onceStamped(){
                    expect(importedTemplate.model).to.equal(partial);
                    done();
                });
            });
            it('should forward Polymer notification to `imported-template`', function() {
                sinon.stub(importedTemplate, "_notifyPath");
                var newVal = "notification works";
                domBind.set("model.Page.doesItWork", newVal);
                expect(importedTemplate._notifyPath).to.be.calledWith("model.doesItWork", newVal)
            });

            describe('after `dom-bind`` changed the partial property', function() {
                beforeEach(function(done) {
                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        importedTemplate.removeEventListener('stamping', onceStamped);
                        domBind.set('model.Page', changedModel);
                        done();
                    });
                });

                it('should attach new `.Html` property as content attribute for `<imported-template>`', function() {
                    expect(importedTemplate.getAttribute("content")).to.equal(changedModel.Html);
                });
                it('should NOT attach new partial model to `imported-template` immediately', function () {
                    expect(importedTemplate.model).to.equal(partial);
                });
                it('should attach new partial model to `imported-template` on `stamping`', function (done) {
                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        expect(importedTemplate.model).to.equal(changedModel);
                        done();
                    });
                });
            });

            describe('after `dom-bind`` changed the partial property to new one with the same Html', function () {
                var changedPartialWithSameHtml;
                beforeEach(function(done) {
                    // IDEA: promisify juicy-html
                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        importedTemplate.removeEventListener('stamping', onceStamped);
                        changedPartialWithSameHtml = {
                            Html: "../old_templateToInclude.html",
                            doesItWork: "works!"
                        };
                        domBind.set('model.Page', changedPartialWithSameHtml);
                        done();
                    });
                });

                it('should attach new `.Html` property as content attribute for `<imported-template>`', function () {
                    expect(importedTemplate.getAttribute("content")).to.equal('../old_templateToInclude.html');
                });
                it('should attach new partial model to `imported-template` immediately', function () {
                    expect(importedTemplate.model).to.equal(changedPartialWithSameHtml);
                });
            });

            describe('after `dom-bind`` changed the partial.Html property', function() {
                beforeEach(function(done) {
                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        importedTemplate.removeEventListener('stamping', onceStamped);
                        domBind.set('model.Page.Html', '../templateToInclude.html');
                        done();
                    });
                });

                it('should attach new `.Html` property as content attribute for `<imported-template>`', function() {
                    expect(importedTemplate.getAttribute("content")).to.equal('../templateToInclude.html');
                });
                it('should NOT attach same partial model to `imported-template`', function() {
                    expect(importedTemplate.model).to.equal(partial);
                });
                it('should attach same partial model to `imported-template`', function() {
                    expect(importedTemplate.model).to.equal(partial);
                });
            });

            describe('after `dom-bind`` removed the inner `Html` property', function () {
                beforeEach(function(done) {
                    importedTemplate.addEventListener('stamping', function onceStamped(){
                        importedTemplate.removeEventListener('stamping', onceStamped);
                        // not realy removing, but Polymer does not support anything better
                        // https://github.com/Polymer/polymer/issues/2565
                        domBind.set('model.Page.Html', null);
                        // domBind.set('model.Page.Html', undefined);
                        done();
                    });
                });

                it('should attach `null` property as content attribute for `<imported-template>`', function () {
                    expect(importedTemplate.getAttribute("content")).to.equal(null);
                });
                it('should attach same partial model to `imported-template`', function () {
                    expect(importedTemplate.model).to.equal(partial);
                });
            });
        });
    </script>

</body>

</html>
