<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>starcounter-include basic test</title>
    <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../document-register-element/build/document-register-element.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>
    <script src="../helpers/pre-config.js"></script>
    <link rel="import" href="../../../polymer/polymer.html">

    <link rel="import" href="../../starcounter-include.html">
</head>

<body>
    <template id="composition">
        <style>
            polyfill-next-selector { content: '.my-class > *'; }
            .my-class ::content {
                font-size: 20px;
            }
        </style>
        <h1>My shadow composition</h1>
        with shadowElement
        <div class="my-class"><content select='[slot="my-slot1"]'></content></div>
        <content select='[slot="my-slot2"]'></content>
    </template>
	<template id="reference-composition">
        <style>
            .my-class > * {
                font-size: 20px;
            }
        </style>
        <h1>My shadow composition</h1>
        with shadowElement
        <div class="my-class"><content select='[slot="my-slot1"]'></content></div>
        <content select='[slot="my-slot2"]'></content>
	</template>
    <test-fixture id="element">
		<template>
            <starcounter-include>
                <div id="childNode1" slot="my-slot1">childNode1</div>
                <div id="childNode2" slot="my-slot2">childNode2</div>
            </starcounter-include>
        </template>
    </test-fixture>
</body>

<script>
describe('starcounter-include when stamps a composition which contains `polyfill-next-selector`', function () {

	var scInclude, replaceTextInStyles;
	afterEach(function (done) {
		// give more time to polyfill cleanup
		setTimeout(done);
	});
	beforeEach(function (done) {
        if(WebComponents && WebComponents.ShadowCSS){
            replaceTextInStyles = sinon.spy(WebComponents.ShadowCSS, 'replaceTextInStyles');
        }
		scInclude = fixture('element');
		scInclude.viewModel = {
			CompositionProvider:{
				Composition$: document.querySelector('#composition').innerHTML
			}
		};
		// scInclude.stamp();
		setTimeout(done, 500);
		// done();
	});
    afterEach(function(){
        replaceTextInStyles.restore();
    });
	it('should call `WebComponents.ShadowCSS.replaceTextInStyles(styles, insertDirectives);` on it\'s shadowRoot', function () {
		expect(replaceTextInStyles).to.have.been.called;
		expect(replaceTextInStyles).to.be.calledWith(
            WebComponents.ShadowCSS.findStyles(scInclude.shadowRoot),
            WebComponents.ShadowCSS.insertDirectives
        );
	});
	it('should replace polyfilled selector', function () {
		expect(scInclude.shadowRoot).to.be.not.null;
		expect(scInclude.shadowRoot.innerHTML.trim()).to.be
			.equal(document.querySelector('#reference-composition').innerHTML.trim());
	});
	it('should apply rules correctly', function () {
		expect(getComputedStyle(scInclude.children[0])['font-size']).to.be.equal('20px')
	});

});
</script>

</html>
