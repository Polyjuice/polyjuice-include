<!--
`launcher-include` - Launcher's `starcounter-include` -
Custom Element (w/ Polymer's TempalteBinding)
with predefined template content, which should be used to include partials.
It's just <template is="imported-template"> wrapped within <juicy-tile-table> and layout editor.
Uses juicy-tiles setup given from DB as layout.
version: 0.5.0

@FIXME (tomalec): Use scoped Partial and layout data once implemented on server-side
@FIXME (tomalec): DRY with default starcounter-include
-->
<!-- Import dependencies -->
<!-- <link rel="import" href="/sys/polymer/polymer.html"> -->

<link rel="import" href="../imported-template/imported-template.html">
<link rel="import" href="../juicy-tile-table/juicy-tile-table.html">
<link rel="import" href="../juicy-tiles-setup-sync/src/juicy-tiles-setup-sync.html">
<!-- <link rel="import" href="/sys/console-log/console-log.html"> -->

<template id="partial-template">
    <juicy-tiles-setup-sync api-url="/sc/layout"></juicy-tiles-setup-sync>
    <juicy-tile-table defaultTileSetup='{
            "height": 1,
            "heightDynamic": true,
            "width": "100%",
            "widthFlexible": true
        }' refreshonmutation>
        <template is="imported-template"></template>
    </juicy-tile-table>
</template>
<script>
    (function() {


        var templ = (document._currentScript || document.currentScript).ownerDocument.getElementById("partial-template");


        var LauncherPartialPrototype = Object.create(HTMLElement.prototype);

        LauncherPartialPrototype.partial = null;
        // LauncherPartialPrototype.html = null;
        LauncherPartialPrototype.mergedHtmlPrefix = '/sc/htmlmerger?';
        LauncherPartialPrototype.defaultHtml = '';

        /**
         * @see Starcounter/starcounter-include - partialAttributeToProperty It's just a copy
         */
        function partialAttributeToProperty(element, attrVal) {
            var attrVal = element.getAttribute("partial");
            if(!attrVal){
                // no value
                return undefined;
            } else if (attrVal.match(/\{\{.*\}\}|\[\[.*\]\]/)) {
                return null;
            } else {
                return JSON.parse(attrVal);
            }
        }
        /**
         * Use predefined template content, rewrite attributes.
         */
        LauncherPartialPrototype.createdCallback = function LPartialCreated() {
            // ugly https://code.google.com/p/chromium/issues/detail?id=430578 workaround
            // if( inDocumentFragment( this ) ){
            //   return ;
            // }
            var partial = partialAttributeToProperty(this);
            var html = buildURL(partial, this.mergedHtmlPrefix, this.defaultHtml);
            var starcounterInclude = this;
            var layout;
            var partialId;
            // define a setter for partial attribute,
            // so it could be change by VanillaJs without Polymer Template Binding
            Object.defineProperty(this, "partial", {
                set: function(newValue) {
                    partial = newValue;
                    starcounterInclude.partialChanged(partial);
                },
                get: function() {
                    return partial;
                }
            });
            // build shadow DOM
            var sroot = this.createShadowRoot();
            sroot.innerHTML = "<style>:host{display:block;}</style><content></content>";

            var clone = document.importNode(templ.content, true);
            this.sync = clone.children[0]; // .getElementsByTagName("JUICY-TILES-SETUP-SYNC");
            this.grid = clone.children[1]; // .getElementsByTagName("juicy-tile-table");
            this.template = this.grid.firstElementChild; // .getElementsByTagName("TEMPLATE");
            html && this.template.setAttribute('content', html);

            // attach partial
            this.partialChanged();

            // attach to light DOM
            this.appendChild(clone);
        };
        /**
         * @see Starcounter/starcounter-include#attributeChangedCallback It's just a copy
         */
        LauncherPartialPrototype.attributeChangedCallback = function(name, oldVal, newVal) {
            if (name === "partial") {
                this.partial = partialAttributeToProperty(this, newVal);
                //d console.log("starcounter-partial attr changed");
            }
        };
        /**
         * Updates inner `imported-template` with partial data given (if applicable)
         * @see Starcounter/starcounter-include#partialChanged it's alsmost a copy
         * @param  {Object} newVal new partial value
         */
        LauncherPartialPrototype.partialChanged = function(newVal) {
            this._htmlChanged();
            this._partialIdChanged();
            this._layoutChanged();
        };

        LauncherPartialPrototype._htmlChanged = function() {
            var html = buildURL(this.partial, this.mergedHtmlPrefix, this.defaultHtml);
            if (html !== this._lastHtml) {
                if (this._lastHtml) {
                    this.template.clear();
                }
                if (!html) {
                    this.template.removeAttribute("content");
                } else {
                    this.template.setAttribute("content", html);
                }
                this._forceLayoutChange = true;
                this._lastHtml = html;
            }
            if (this.template.model != this.partial) {
                this.template.model = this.partial
            }
        };

        LauncherPartialPrototype._partialIdChanged = function() {
            var partialId;
            if (this.partial) {
                if (this.partial.Launcher) {
                    partialId = this.partial.Launcher.PartialId; //should always be string
                }
            }
            if (partialId !== this._lastPartialId) {
                if (!partialId) {
                    this.sync.removeAttribute("name");
                    this.grid.removeAttribute("name");
                } else {
                    this.sync.setAttribute("name", partialId);
                    this.grid.setAttribute("name", partialId);
                }
                this._lastPartialId = partialId;
            }
        };

        LauncherPartialPrototype._layoutChanged = function() {
            var layout;
            if (this.partial) {
                if (this.partial.Launcher) {
                    layout = this.partial.Launcher.Layout; //should always be string
                }
            }
            if (layout !== this._lastLayout || this._forceLayoutChange) {
                if (!layout) {
                    this.sync.storedValue = null;
                    this.grid.setup = {
                        gutter: 0,
                        width: 1200,
                        direction: "horizontal",
                        items: []
                    };
                } else {
                    var parsedLayout = JSON.parse(layout);
                    this.sync.storedValue = parsedLayout;
                    // make clone to avoid direct binding
                    this.grid.setup = JSON.parse(layout);
                }
                this._forceLayoutChange = false;
                this._lastLayout = layout;
            }
        };


        /**
         * Forward Polymer notification downwards from `<template is="dom-bind">`
         * to <template is="imported-template">
         * @param  {String} path Polymer notification path
         * @param  {Mixed} value New value
         */
        LauncherPartialPrototype._notifyPath = function(path, value) {
            if (path.indexOf("partial.") == 0) {

                if (
                    path === "partial.Html" ||
                    path.indexOf("partial.Launcher.") === 0 ||
                    // path.match(/^partial\.[^.]+\.Html$/)
                    (path.indexOf('.Html') === path.length - 5) && path.slice(8, -5).indexOf('.') === -1
                ) {
                    this.partialChanged(this.partial);
                } else {
                    if (this.template._notifyPath) {
                        this.template._notifyPath(path.replace("partial.", "model."), value);
                    }
                }
            }
        };
        /**
         * Retrieves URL of HTML file to be loaded from given partial.
         * For merged partials/namespaced JSONs without
         * `.Html` property on root level it builds one out of
         * `.Html` properties from nested objects
         * {prefix}{key1}={partial.key1.Html}&{key2}={partial.key2.Html}&{key3}={defaultURL}
         * Parameters are URI encoded, for scopes without `.Html` property _defaultURL_ is used
         * @param  {Object} partial    partial object
         * @param  {String} prefix     prefix for merged partials
         * @param  {String} defaultURL Html to be used for nodes that does not have one
         * @return {String}            [description]
         */
        function buildURL(partial, prefix, defaultURL) {
            if(partial){
                if (partial.Launcher) {
                    //workaround for https://github.com/StarcounterPrefabs/Launcher/issues/224
                    //should be removed when the original issue with not patched Html is resolved
                    return partial.Launcher.MergedHtml;
                }
                if(partial.Html !== undefined){
                    return partial.Html;
                } else {
                    var htmls = [];
                    for (var key in partial){
                        if (partial.hasOwnProperty(key)) {
                            htmls.push(
                                key +
                                '=' +
                                (partial[key].Html && encodeURIComponent(partial[key].Html) || defaultURL)
                            );
                        }
                    }
                    // Workaround for https://github.com/Starcounter/starcounter-include/issues/12
                    return htmls.length && (prefix + htmls.join('&')) || undefined;
                    // return prefix + htmls.join('&');
                }
            } else {
                return undefined;
            }
        };

        document.registerElement('starcounter-include', {
            prototype: LauncherPartialPrototype
        });
    })();

</script>
