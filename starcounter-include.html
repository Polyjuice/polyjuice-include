<!--
`launcher-include` - Launcher's `starcounter-include` -
Custom Element (w/ Polymer's TempalteBinding)
with predefined template content, which should be used to include partials.
It's just <template is="imported-template"> wrapped within <juicy-tile-table> and layout editor.
Uses juicy-tiles setup given from DB as layout.
version: 0.3.1

@FIXME (tomalec): Use scoped Partial and layout data once implemented on server-side
@FIXME (tomalec): DRY with default starcounter-include
-->
<!-- Import dependencies -->
<!-- <link rel="import" href="/sys/polymer/polymer.html"> -->

<link rel="import" href="../imported-template/imported-template.html">
<link rel="import" href="../juicy-tile-table/juicy-tile-table.html">
<link rel="import" href="../juicy-tiles-setup-sync/src/juicy-tiles-setup-sync.html">
<!-- <link rel="import" href="/sys/console-log/console-log.html"> -->

<template id="partial-template">
    <juicy-tiles-setup-sync api-url="/sc/layout"></juicy-tiles-setup-sync>
    <juicy-tile-table defaultTileSetup='{
            "height": 1,
            "heightDynamic": true,
            "width": "100%",
            "widthFlexible": true
        }' refreshonmutation>
        <template is="imported-template"></template>
    </juicy-tile-table>
</template>
<script>
    (function() {


        var templ = (document._currentScript || document.currentScript).ownerDocument.getElementById("partial-template");


        var LauncherPartialPrototype = Object.create(HTMLElement.prototype);

        LauncherPartialPrototype.partial = null;

        /**
         * @see Starcounter/starcounter-include - partialAttributeToProperty It's just a copy
         */
        function partialAttributeToProperty(element, attrVal) {
            var attrVal = element.getAttribute("partial");
            if(!attrVal){
                // no value
                return undefined;
            } else if (attrVal.match(/\{\{.*\}\}|\[\[.*\]\]/)) {
                return null;
            } else {
                return JSON.parse(attrVal);
            }
        }
        /**
         * Use predefined template content, rewrite attributes.
         */
        LauncherPartialPrototype.createdCallback = function LPartialCreated() {
            // ugly https://code.google.com/p/chromium/issues/detail?id=430578 workaround
            // if( inDocumentFragment( this ) ){
            //   return ;
            // }
            var partial = partialAttributeToProperty(this);
            var starcounterInclude = this;
            var layout;
            // define a setter for partial attribute,
            // so it could be change by VanillaJs without Polymer Template Binding
            Object.defineProperty(this, "partial", {
                set: function(newValue) {
                    partial = newValue;
                    starcounterInclude.partialChanged(partial);
                },
                get: function() {
                    return partial;
                }
            });
            // build shadow DOM
            var sroot = this.createShadowRoot();
            sroot.innerHTML = "<style>:host{display:block;}</style><content></content>";

            var clone = document.importNode(templ.content, true);
            this.sync = clone.children[0]; // .getElementsByTagName("JUICY-TILES-SETUP-SYNC");
            this.grid = clone.children[1]; // .getElementsByTagName("juicy-tile-table");
            this.template = this.grid.firstElementChild; // .getElementsByTagName("TEMPLATE");
            // attach partial
            if(partial){
                partial.Html && this.template.setAttribute('content', partial.Html);
                var partialId = partial.PartialId;
                if(partialId){
                    this.sync.setAttribute("name", partialId);
                    this.grid.setAttribute("name", partialId);
                }
                layout = partial.layout;
            }
            this.template.model = partial;
            //Up to Starcounter 2.1.1261, layout came as an object
            //Starting from one of the following versions, layout will come as a string, for the reasons described in:
            //https://github.com/Juicy/juicy-tile-editor/issues/127
            //It can be changed again when this is fixed:
            //https://github.com/Starcounter/Starcounter/issues/3074
            var parsedLayout = typeof layout == "string" ? JSON.parse(layout) : layout;
            this.sync.storedValue = parsedLayout;
            // make clone to avoid direct binding
            this.grid.setup = typeof layout == "string" ? JSON.parse(layout) : layout && JSON.parse(JSON.stringify(layout));

            // attach to light DOM
            this.appendChild(clone);
        };
        /**
         * @see Starcounter/starcounter-include#attributeChangedCallback It's just a copy
         */
        LauncherPartialPrototype.attributeChangedCallback = function(name, oldVal, newVal) {
            if (name === "partial") {
                this.partial = partialAttributeToProperty(this, newVal);
                //d console.log("starcounter-partial attr changed");
            }
        };
        /**
         * Updates inner `imported-template` with partial data given (if applicable)
         * @see Starcounter/starcounter-include#partialChanged it's alsmost a copy
         * @param  {Object} newVal new partial value
         */
        LauncherPartialPrototype.partialChanged = function(newVal) {
            var html, partialId, layout;
            if (this.partial) {
                html = this.partial.Html;
                !html && console.warn("partial.Html for", this, "is missing.");
                partialId = this.partial.PartialId;
                !partialId && console.warn("partial.PartialId for", this, "is missing.");
                layout = this.partial.layout;
            }
            //Up to Starcounter 2.1.1261, layout came as an object
            //Starting from one of the following versions, layout will come as a string, for the reasons described in:
            //https://github.com/Juicy/juicy-tile-editor/issues/127
            //It can be changed again when this is fixed:
            //https://github.com/Starcounter/Starcounter/issues/3074
            var parsedLayout = typeof layout == "string" ? JSON.parse(layout) : layout;
            this.sync.storedValue = parsedLayout;

            if(partialId === null || partialId === undefined){
                this.sync.removeAttribute("name");
                this.grid.removeAttribute("name");
            } else {
                this.sync.setAttribute("name", partialId);
                this.grid.setAttribute("name", partialId);
            }
            // make clone to avoid direct binding
            this.grid.setup = typeof layout == "string" ? JSON.parse(layout) : layout && JSON.parse(JSON.stringify(layout));
            if(html === null || html === undefined){
                this.template.removeAttribute("content");
            } else {
                this.template.setAttribute("content", html);
            }
            this.template.model = this.partial;
        };


        /**
         * Forward Polymer notification downwards from `<template is="dom-bind">`
         * to <template is="imported-template">
         * @param  {String} path Polymer notification path
         * @param  {Mixed} value New value
         */
        LauncherPartialPrototype._notifyPath = function(path, value) {
            if (path.indexOf("partial.") == 0) {
                if (this.template._notifyPath) {
                    this.template._notifyPath(path.replace("partial.", "model."), value);
                }
            }
        };

        document.registerElement('starcounter-include', {
            prototype: LauncherPartialPrototype
        });
    })();
</script>
